#include "timer.h"
#include "adc.h"
#include "iir.h" 
#include "usart.h"
#include "oled.h"
#include "dac.h"
#include "pwm.h"
#include "PID.h"

extern int n;
extern __IO uint16_t ADC_ConvertedValue[4];
float ADC_ConvertedValueLocal[4]={0}; 

double K=0.6;
double dt1,dt2,sum,sum0,sum1,sum2,Vi,Vread0,Vread1,dt=0;
int flag=-1,FLAG=-1,FLAG1=-1;
int num=0,num0=0,num1=0,num2=0,count=0;

uint16_t POINT_NUM =400;
__IO uint16_t period_class = 1;
double high=0;
const uint16_t indexWave[] = {
2000, 2032, 2063, 2095, 2126, 2158, 2189, 2220, 2252, 2283, 2314, 2345, 2376, 2407, 2438, 2469, 2500, 2530, 2560, 2591, 2621, 2651, 2680, 2710, 2739, 2769, 2798, 2826, 2855, 2884, 2912, 2940, 2967, 2995, 3022, 3049, 3076, 3102, 3129, 3154, 3180, 3205, 3230, 3255, 3280, 3304, 3327, 3351, 3374, 3397, 3419, 3441, 3463, 3484, 3505, 3526, 3546, 3566, 3585, 3604, 3623, 3641, 3659, 3676, 3693, 3710, 3726, 3742, 3757, 3772, 3786, 3800, 3814, 3827, 3839, 3851, 3863, 3874, 3885, 3895, 3905, 3914, 3923, 3932, 3939, 3947, 3954, 3960, 3966, 3972, 3977, 3981, 3985, 3988, 3991, 3994, 3996, 3997, 3998, 3999, 3999, 3998, 3997, 3996, 3994, 3991, 3988, 3985, 3981, 3977, 3972, 3966, 3960, 3954, 3947, 3939, 3932, 3923, 3914, 3905, 3895, 3885, 3874, 3863, 3851, 3839, 3827, 3814, 3800, 3786, 3772, 3757, 3742, 3726, 3710, 3693, 3676, 3659, 3641, 3623, 3604, 3585, 3566, 3546, 3526, 3505, 3484, 3463, 3441, 3419, 3397, 3374, 3351, 3327, 3304, 3280, 3255, 3230, 3205, 3180, 3154, 3129, 3102, 3076, 3049, 3022, 2995, 2967, 2940, 2912, 2884, 2855, 2826, 2798, 2769, 2739, 2710, 2680, 2651, 2621, 2591, 2560, 2530, 2500, 2469, 2438, 2407, 2376, 2345, 2314, 2283, 2252, 2220, 2189, 2158, 2126, 2095, 2063, 2032, 2000,2000, 1968, 1937, 1905, 1874, 1842, 1811, 1780, 1748, 1717, 1686, 1655, 1624, 1593, 1562, 1531, 1500, 1470, 1440, 1409, 1379, 1349, 1320, 1290, 1261, 1231, 1202, 1174, 1145, 1116, 1088, 1060, 1033, 1005, 978, 951, 924, 898, 871, 846, 820, 795, 770, 745, 720, 696, 673, 649, 626, 603, 581, 559, 537, 516, 495, 474, 454, 434, 415, 396, 377, 359, 341, 324, 307, 290, 274, 258, 243, 228, 214, 200, 186, 173, 161, 149, 137, 126, 115, 105, 95, 86, 77, 68, 61, 53, 46, 40, 34, 28, 23, 19, 15, 12, 9, 6, 4, 3, 2, 1, 1, 2, 3, 4, 6, 9, 12, 15, 19, 23, 28, 34, 40, 46, 53, 61, 68, 77, 86, 95, 105, 115, 126, 137, 149, 161, 173, 186, 200, 214, 228, 243, 258, 274, 290, 307, 324, 341, 359, 377, 396, 415, 434, 454, 474, 495, 516, 537, 559, 581, 603, 626, 649, 673, 696, 720, 745, 770, 795, 820, 846, 871, 898, 924, 951, 978, 1005, 1033, 1060, 1088, 1116, 1145, 1174, 1202, 1231, 1261, 1290, 1320, 1349, 1379, 1409, 1440, 1470, 1500, 1531, 1562, 1593, 1624, 1655, 1686, 1717, 1748, 1780, 1811, 1842, 1874, 1905, 1937, 1968, 2000,
2000, 2032, 2063, 2095, 2126, 2158, 2189, 2220, 2252, 2283, 2314, 2345, 2376, 2407, 2438, 2469, 2500, 2530, 2560, 2591, 2621, 2651, 2680, 2710, 2739, 2769, 2798, 2826, 2855, 2884, 2912, 2940, 2967, 2995, 3022, 3049, 3076, 3102, 3129, 3154, 3180, 3205, 3230, 3255, 3280, 3304, 3327, 3351, 3374, 3397, 3419, 3441, 3463, 3484, 3505, 3526, 3546, 3566, 3585, 3604, 3623, 3641, 3659, 3676, 3693, 3710, 3726, 3742, 3757, 3772, 3786, 3800, 3814, 3827, 3839, 3851, 3863, 3874, 3885, 3895, 3905, 3914, 3923, 3932, 3939, 3947, 3954, 3960, 3966, 3972, 3977, 3981, 3985, 3988, 3991, 3994, 3996, 3997, 3998, 3999, 3999, 3998, 3997, 3996, 3994, 3991, 3988, 3985, 3981, 3977, 3972, 3966, 3960, 3954, 3947, 3939, 3932, 3923, 3914, 3905, 3895, 3885, 3874, 3863, 3851, 3839, 3827, 3814, 3800, 3786, 3772, 3757, 3742, 3726, 3710, 3693, 3676, 3659, 3641, 3623, 3604, 3585, 3566, 3546, 3526, 3505, 3484, 3463, 3441, 3419, 3397, 3374, 3351, 3327, 3304, 3280, 3255, 3230, 3205, 3180, 3154, 3129, 3102, 3076, 3049, 3022, 2995, 2967, 2940, 2912, 2884, 2855, 2826, 2798, 2769, 2739, 2710, 2680, 2651, 2621, 2591, 2560, 2530, 2500, 2469, 2438, 2407, 2376, 2345, 2314, 2283, 2252, 2220, 2189, 2158, 2126, 2095, 2063, 2032, 2000,2000, 1968, 1937, 1905, 1874, 1842, 1811, 1780, 1748, 1717, 1686, 1655, 1624, 1593, 1562, 1531, 1500, 1470, 1440, 1409, 1379, 1349, 1320, 1290, 1261, 1231, 1202, 1174, 1145, 1116, 1088, 1060, 1033, 1005, 978, 951, 924, 898, 871, 846, 820, 795, 770, 745, 720, 696, 673, 649, 626, 603, 581, 559, 537, 516, 495, 474, 454, 434, 415, 396, 377, 359, 341, 324, 307, 290, 274, 258, 243, 228, 214, 200, 186, 173, 161, 149, 137, 126, 115, 105, 95, 86, 77, 68, 61, 53, 46, 40, 34, 28, 23, 19, 15, 12, 9, 6, 4, 3, 2, 1, 1, 2, 3, 4, 6, 9, 12, 15, 19, 23, 28, 34, 40, 46, 53, 61, 68, 77, 86, 95, 105, 115, 126, 137, 149, 161, 173, 186, 200, 214, 228, 243, 258, 274, 290, 307, 324, 341, 359, 377, 396, 415, 434, 454, 474, 495, 516, 537, 559, 581, 603, 626, 649, 673, 696, 720, 745, 770, 795, 820, 846, 871, 898, 924, 951, 978, 1005, 1033, 1060, 1088, 1116, 1145, 1174, 1202, 1231, 1261, 1290, 1320, 1349, 1379, 1409, 1440, 1470, 1500, 1531, 1562, 1593, 1624, 1655, 1686, 1717, 1748, 1780, 1811, 1842, 1874, 1905, 1937, 1968, 2000,
2000, 2032, 2063, 2095, 2126, 2158, 2189, 2220, 2252, 2283, 2314, 2345, 2376, 2407, 2438, 2469, 2500, 2530, 2560, 2591, 2621, 2651, 2680, 2710, 2739, 2769, 2798, 2826, 2855, 2884, 2912, 2940, 2967, 2995, 3022, 3049, 3076, 3102, 3129, 3154, 3180, 3205, 3230, 3255, 3280, 3304, 3327, 3351, 3374, 3397, 3419, 3441, 3463, 3484, 3505, 3526, 3546, 3566, 3585, 3604, 3623, 3641, 3659, 3676, 3693, 3710, 3726, 3742, 3757, 3772, 3786, 3800, 3814, 3827, 3839, 3851, 3863, 3874, 3885, 3895, 3905, 3914, 3923, 3932, 3939, 3947, 3954, 3960, 3966, 3972, 3977, 3981, 3985, 3988, 3991, 3994, 3996, 3997, 3998, 3999, 3999, 3998, 3997, 3996, 3994, 3991, 3988, 3985, 3981, 3977, 3972, 3966, 3960, 3954, 3947, 3939, 3932, 3923, 3914, 3905, 3895, 3885, 3874, 3863, 3851, 3839, 3827, 3814, 3800, 3786, 3772, 3757, 3742, 3726, 3710, 3693, 3676, 3659, 3641, 3623, 3604, 3585, 3566, 3546, 3526, 3505, 3484, 3463, 3441, 3419, 3397, 3374, 3351, 3327, 3304, 3280, 3255, 3230, 3205, 3180, 3154, 3129, 3102, 3076, 3049, 3022, 2995, 2967, 2940, 2912, 2884, 2855, 2826, 2798, 2769, 2739, 2710, 2680, 2651, 2621, 2591, 2560, 2530, 2500, 2469, 2438, 2407, 2376, 2345, 2314, 2283, 2252, 2220, 2189, 2158, 2126, 2095, 2063, 2032, 2000,2000, 1968, 1937, 1905, 1874, 1842, 1811, 1780, 1748, 1717, 1686, 1655, 1624, 1593, 1562, 1531, 1500, 1470, 1440, 1409, 1379, 1349, 1320, 1290, 1261, 1231, 1202, 1174, 1145, 1116, 1088, 1060, 1033, 1005, 978, 951, 924, 898, 871, 846, 820, 795, 770, 745, 720, 696, 673, 649, 626, 603, 581, 559, 537, 516, 495, 474, 454, 434, 415, 396, 377, 359, 341, 324, 307, 290, 274, 258, 243, 228, 214, 200, 186, 173, 161, 149, 137, 126, 115, 105, 95, 86, 77, 68, 61, 53, 46, 40, 34, 28, 23, 19, 15, 12, 9, 6, 4, 3, 2, 1, 1, 2, 3, 4, 6, 9, 12, 15, 19, 23, 28, 34, 40, 46, 53, 61, 68, 77, 86, 95, 105, 115, 126, 137, 149, 161, 173, 186, 200, 214, 228, 243, 258, 274, 290, 307, 324, 341, 359, 377, 396, 415, 434, 454, 474, 495, 516, 537, 559, 581, 603, 626, 649, 673, 696, 720, 745, 770, 795, 820, 846, 871, 898, 924, 951, 978, 1005, 1033, 1060, 1088, 1116, 1145, 1174, 1202, 1231, 1261, 1290, 1320, 1349, 1379, 1409, 1440, 1470, 1500, 1531, 1562, 1593, 1624, 1655, 1686, 1717, 1748, 1780, 1811, 1842, 1874, 1905, 1937, 1968, 2000};	
	
	void TIM3_Int_Init(u16 arr,u16 psc)//spwm采点定时器配置
{
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;
	NVIC_InitTypeDef NVIC_InitStructure;
	
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM3,ENABLE);  ///使能TIM3时钟
	
  TIM_TimeBaseInitStructure.TIM_Period = arr; 	//自动重装载值
	TIM_TimeBaseInitStructure.TIM_Prescaler=psc;  //定时器分频
	TIM_TimeBaseInitStructure.TIM_CounterMode=TIM_CounterMode_Up; //向上计数模式
	TIM_TimeBaseInitStructure.TIM_ClockDivision=TIM_CKD_DIV1; 
	
	TIM_TimeBaseInit(TIM3,&TIM_TimeBaseInitStructure);//初始化TIM3
	
	TIM_ITConfig(TIM3,TIM_IT_Update,ENABLE); //允许定时器3更新中断
	TIM_Cmd(TIM3,ENABLE); //使能定时器3
	
	NVIC_InitStructure.NVIC_IRQChannel=TIM3_IRQn; //定时器3中断
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=0x00; //抢占优先级1
	NVIC_InitStructure.NVIC_IRQChannelSubPriority=0x01;
	NVIC_InitStructure.NVIC_IRQChannelCmd=ENABLE;
	NVIC_Init(&NVIC_InitStructure);
	
}

void  TIM3_IRQHandler(void)//采点中断函数
{			//用于PWM查表
	static uint16_t period_cnt = 0;		//用于计算周期数
	static uint16_t pwm_index = 0;
	
	if (TIM_GetITStatus(TIM3, TIM_IT_Update) != RESET)	//TIM_IT_Update
 	{			
			period_cnt++;
			TIM8->CCR1 = 2000+K*(indexWave[pwm_index]-2000);	//根据PWM表修改定时器的比较寄存器值
		  TIM8->CCR2 = 3999-(2000+K*(indexWave[pwm_index]-2000));
			if(period_cnt >=period_class)				 				
			{				
				pwm_index++;
					}												//标志PWM表指向下一个元素
				if(pwm_index >=POINT_NUM)
				{					
					pwm_index=0;				  					
				}			
				period_cnt=0;		
				count=pwm_index;
			}	
	TIM_ClearITPendingBit (TIM3, TIM_IT_Update);	//必须要清除中断标志位
	}		
	

	
	
void TIM4_Int_Init(u16 arr,u16 psc)//计时定时器配置
{
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;
	NVIC_InitTypeDef NVIC_InitStructure;
	
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM4,ENABLE);
	
  TIM_TimeBaseInitStructure.TIM_Period = arr; 	//自动重装载值
	TIM_TimeBaseInitStructure.TIM_Prescaler=psc;  //定时器分频
	TIM_TimeBaseInitStructure.TIM_CounterMode=TIM_CounterMode_Up; //向上计数模式
	TIM_TimeBaseInitStructure.TIM_ClockDivision=TIM_CKD_DIV1; 
	
	TIM_TimeBaseInit(TIM4,&TIM_TimeBaseInitStructure);//初始化TIM3
	
	TIM_ITConfig(TIM4,TIM_IT_Update,ENABLE); //允许定时器3更新中断
	TIM_Cmd(TIM4,ENABLE); //使能定时器3
	
	NVIC_InitStructure.NVIC_IRQChannel=TIM4_IRQn; //定时器3中断
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=0x00;//
	NVIC_InitStructure.NVIC_IRQChannelSubPriority=0x03; //子优先级3
	NVIC_InitStructure.NVIC_IRQChannelCmd=ENABLE;
	NVIC_Init(&NVIC_InitStructure);
	
}




void TIM4_IRQHandler(void)
{
if (TIM_GetITStatus(TIM4, TIM_IT_Update) != RESET){
	if(num0<10){
	ADC_ConvertedValueLocal[0] =(float) ADC_ConvertedValue[0];
	sum0+=ADC_ConvertedValueLocal[0];
	num0++;
	}
	else{
	Vread0=sum0/(double)num0;
	Vread1=indexWave[count];	
	if(Vread0>(Vi+2)){
	flag=1;
	}
	if(Vread0<(Vi-2)){ 
	flag=0;
	}
	
	if(Vread1>(2000)){
	dt2=4095;
	if(flag==0){
	if(FLAG==0){
	FLAG1=0;
	FLAG=-1;
	}//落后
	if(FLAG1==0){dt1=0;}
	else{dt1=4095;}
	}
	if(flag==1){
	if(FLAG1==0){dt1=2047;}
	else{dt1=2047;}
	FLAG=0;
	}}
	
	if(Vread1<(2000)){
	dt2=0; 
	if(flag==1){
	if(FLAG==0){
	FLAG1=1;
	FLAG=-1;
	}
	if(FLAG1==1){dt1=4095;}
	else{dt1=0;}
	}
	if(flag==0){
  if(FLAG1==1){dt1=2047;}
	else{dt1=2047;}}
	}
	sum0=0;
	sum1=0;
	num0=0;
	
	}
	
  if(num<100){
	num++;
	}
	else{
	ADC_ConvertedValueLocal[0] =(float) ADC_ConvertedValue[0];
	Vi=IIR_Realize(ADC_ConvertedValueLocal[0]);
	dt=IIR_Realize(dt1);
	Dac1_Set_Vol(dt);
	num=0;
	}

TIM_ClearITPendingBit (TIM4, TIM_IT_Update);
}}


